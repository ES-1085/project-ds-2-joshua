---
title: "Red-backed salamander  and distribution in north-central Massachusetts"
author: "Joshua A. Harkness"
date: "2024-02-13"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Packages
```{r load-packages}
#install.packages(gridExtra)
library(tidyverse)
library(broom)
library(stringr)
library(sf)
library(ggspatial)
library(readxl)
library(GGally)
library(gridExtra)
library(grid)
library(tidymodels)
library(MASS)
library(simfit)
library(ggpmisc)
library(iNEXT)
library(pscl)
library(cowplot)
```

## Load Data
```{r load-datafiles}
plots <- read_csv("/cloud/project/data/hf131-01-plot.csv")
aco <- read_csv("/cloud/project/data/hf131-04-aco.csv")
pc <- read_csv("/cloud/project/data/hf131-05-pc-abund.csv")
herps <- read_csv("/cloud/project/data/hf131-06-herps.csv")
mass_towns <- st_read("/cloud/project/data/Community Boundaries (Towns) from Survey Points.shp")
coords <- read_csv("/cloud/project/data/coords.csv")
```
## Map plots
```{r transform-crs-mass_towns}
mass_towns <- st_transform(mass_towns, "+init=epsg:4326")
```

```{r plot-mass_towns-coords}
state_map <- ggplot(mass_towns) +
  geom_sf() +
  geom_point(data = coords, (aes(x = long_dd, y = lat_dd)), alpha = 0.5) +
   theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank()) +
  ggspatial::annotation_scale(
    location = "bl",
    bar_cols = c("grey60", "white"),
    text_family = "ArcherPro Book")

site_map <- ggplot(mass_towns) +
  geom_sf() +
  geom_point(data = coords, (aes(x = long_dd, y = lat_dd)), alpha = 0.5) +
  labs(title = "Paired sites in north central Massachusetts",
       x = "Longitude",
       y = "Latitude",
       caption = "WGS 1984") +
  xlim(-72.43, -71.75) +
  ylim(42.33, 42.7) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
   ggspatial::annotation_north_arrow(
    location = "tr", which_north = "true",
    pad_x = unit(0, "in"), pad_y = unit(0.2, "in"),
    style = ggspatial::north_arrow_fancy_orienteering(
      fill = c("grey40", "white"),
      line_col = "grey20",
      text_family = "ArcherPro Book")) +
  ggspatial::annotation_scale(
    location = "bl",
    bar_cols = c("grey60", "white"),
    text_family = "ArcherPro Book") +
  annotate("text", x = c(-71.9, -72.12, -72.27, -72.1, -72.13, -72.08, -72.23, -72.36, -72.39, -72.38), y = c(42.52, 42.44, 42.49, 42.54, 42.61, 42.68, 42.66, 42.7, 42.66, 42.6), label = c("Mount Wachusett", "Slab City", "Tom Swamp", "Prospect Hill", "Millers River", "Beryl Hill", "Warwick SF", "Mount Grace SF", "Northfield SF", "Erving SF"))

main.plot <- site_map

inset.plot <- state_map

map1 <-
  ggdraw() +
  draw_plot(main.plot) +
  draw_plot(inset.plot, x = 0.585, y = .145, width = .3, height = .3)

map1

ggsave("sitemap.png")

```

## P. cinereus 
### Calculate  per cover board

```{r select-vars-aco}
aco <- aco %>%
  dplyr::select(plot, asn, aco, pca, osn, other.sp)
```

```{r calc-abund-aco}
aco_abund <- aco %>%
  group_by(plot, asn, aco) %>%
  summarize(n_ind = sum(pca), .groups = "keep")

aco_abund
```
Still getting 241 detections of P. cinereus, but when grouping by `plot` and `asn`, we get 310 cover board observations instead of the original 300 -- not sure why it's doing this, but presumbly it's only adding a ten zeros to the dataframe, so I'm going to let it go at that.

```{r join-aco_abund-plots}
df <- left_join(aco_abund, plots)
df

write_csv(df, "/cloud/project/data/df.csv")
```
```{r glimpse-df}
glimpse(df)
sum(df$n_ind)
```
Now 310 cover board observations, still with 241 P. cinereus detections.
```{r check-unique-n_ind-vals}
unique(df$n_ind)
```

```{r barplot-abundance-dist}
df %>%
  ggplot(aes(x = n_ind)) +
  geom_bar(fill = "seagreen4", color = "black") +
  labs(title = "P. cinereus abundance distribution",
       x = "Abundance per cover board",
       y = "Count")

ggsave("abundance_dist.png")
```

#### Forest type comparisons
```{r plot-violin1}
violin1 <- df %>%
  ggplot(aes(x = ft, y = n_ind, fill = ft)) +
  geom_violin() +
  labs(title = "P. cinereus by forest type",
       x = "Forest type",
       y = "Abundance per cover board") +
  theme_classic() +
  theme(legend.position = "none") +
  scale_x_discrete(labels = c("Mixed deciduous", "Hemlock")) +
  ylim(0,9)

errbar1 <- df %>%
  group_by(ft) %>%
  summarise(mean = mean(n_ind),
            sd = sd(n_ind),
            n = n(),
            SE = sd(n_ind) / sqrt(n())) %>%
  ggplot(aes(x = ft, y = mean)) +
  geom_point(shape = 15, size = 3) +
  geom_errorbar(aes(ymin = mean - SE, ymax = mean + SE), width = 0.2) +
  labs(title = "",
       x = "",
       y = "Mean ") +
  theme_classic() +
  annotate("text", x = 0.8, y = 0.9, label = "P = 0.982")

main.plot <- violin1

inset.plot <- errbar1

plot.with.inset <-
  ggdraw() +
  draw_plot(main.plot) +
  draw_plot(inset.plot, x = .65, y = .65, width = .4, height = .4)

plot.with.inset

ggsave("abundance_comp_ft.png")
```

Interesting that the higher outliers in the hemlock group make the mean higher for that group, while the medians of the two groups are the same.  Is median a good summary statistic when it is equal to zero?

Wilcoxon test for difference given the extreme skew.
```{r test-wilcox-n_ind-df}
wilcox.test(df$n_ind ~ df$ft)
```
Report: I found no significant difference in mean  per cover board between mixed deciduous and hemlock forests (Wilcoxon rank sum test, W = 1198, P = 0.982).

#### Site comparisons
```{r plot-errorbar-mean-abundance-site}
df %>%
  group_by(site) %>%
  summarise(mean = mean(n_ind),
            sd = sd(n_ind),
            n = n(),
            SE = sd(n_ind) / sqrt(n())) %>%
  ggplot(aes(x = site, y = mean)) +
  geom_point(shape = 15, size = 3) +
  geom_errorbar(aes(ymin = mean - SE, ymax = mean + SE), width = 0.2) +
  labs(title = "P. cinereus abundance by site",
       x = "Site",
       y = "Mean abundance per cover board") +
  theme_bw()

ggsave("mean_site_abundance_comp.png")
```

```{r test-kw1}
kw1 = kruskal.test(df$n_ind ~ df$site)
kw1
```
Significant, so we will use a Dunn's post hoc test.

```{r test-dunn1}
library(dunn.test)

dunn.test(df$n_ind, df$site)
```

Add report, not sure if this will go into presentation, but it is worth knowing differences between sites here.

### Modeling
#### Assess normality
```{r hist-some-predictors}
p1 <- ggplot(df, aes(x = ba)) +
  geom_histogram(fill = "skyblue", color = "black") +
  labs(x = "Basal area (m2/ha)",
       y = "")
p2 <- ggplot(df, aes(x = st.ha)) +
  geom_histogram(fill = "skyblue", color = "black") +
  labs(x = "Stems/ha",
       y = "")
p3 <- ggplot(df, aes(x = ts)) +
  geom_histogram(fill = "skyblue", color = "black") +
  labs(x = "Percent hemlock",
       y = "Count")
p4 <- ggplot(df, aes(x = canopy.cover)) +
  geom_histogram(fill = "skyblue", color = "black") +
  labs(x = "Percent canopy cover",
       y = "")
p5 <- ggplot(df, aes(x = vcwd.con)) +
  geom_histogram(fill = "skyblue", color = "black") +
  labs(x = "Volume CWD (m3)",
       y = "")
p6 <- ggplot(df, aes(x = soil.ph)) +
  geom_histogram(fill = "skyblue", color = "black") +
  labs(x = "Soil pH",
       y = "")

hist_some_predictors <- grid.arrange(p1, p2, p3, p4, p5, p6)

ggsave("hist_some_predictors.png", plot = hist_some_predictors)
```


#### Assess relationships
```{r plot-relationships, message = FALSE, warning = FALSE}
p1 <- ggplot(df, aes(x = ba, y = n_ind)) +
  geom_jitter(alpha = 0.25) +
  geom_smooth(method = "lm") +
  labs(x = "Basal area (m2/ha)",
       y = "")
p2 <- ggplot(df, aes(x = st.ha, y = n_ind)) +
  geom_jitter(alpha = 0.25) +
  geom_smooth(method = "lm") +
  labs(x = "Stems/ha",
       y = "")
p3 <- ggplot(df, aes(x = ts, y = n_ind)) +
  geom_jitter(alpha = 0.25) +
  geom_smooth(method = "lm") +
  labs(x = "Percent hemlock",
       y = "")
p4 <- ggplot(df, aes(x = canopy.cover, y = n_ind)) +
  geom_jitter(alpha = 0.25) +
  geom_smooth(method = "lm") +
  labs(x = "Percent canopy cover",
       y = "Abundance per cover board")
p5 <- ggplot(df, aes(x = cwd.con, y = n_ind)) +
  geom_jitter(alpha = 0.25) +
  geom_smooth(method = "lm") +
  labs(x = "Number CWD pieces contact",
       y = "")
p6 <- ggplot(df, aes(x = vcwd.con, y = n_ind)) +
  geom_jitter(alpha = 0.25) +
  geom_smooth(method = "lm") +
  labs(x = "Volume CWD contact",
       y = "")
p7 <- ggplot(df, aes(x = avg.dc, y = n_ind)) +
  geom_jitter(alpha = 0.25) +
  geom_smooth(method = "lm") +
  labs(x = "Average decay class",
       y = "")
p8 <- ggplot(df, aes(x = tot.snags, y = n_ind)) +
  geom_jitter(alpha = 0.25) +
  geom_smooth(method = "lm") +
  labs(x = "Total snags",
       y = "")
p9 <- ggplot(df, aes(x = soil.ph, y = n_ind)) +
  geom_jitter(alpha = 0.25) +
  geom_smooth(method = "lm") +
  labs(x = "Soil pH",
       y = "")

scatterplots_abundance_predictors <- grid.arrange(p1, p2, p3, p4, p5, p6, p7, p8, p9, top = grid::textGrob("Relationships between P. cinereus abundance and predictors"))

ggsave("scatterplots_abundance_predictors.png", plot = scatterplots_abundance_predictors)
```

#### Hurdle model without interaction

```{r hurdle-nb1}
df1 <- na.omit(df)
hurdle_nb1 <- hurdle(n_ind ~ ft + ts + ba + st.ha + canopy.cover + cwd.con + vcwd.con + avg.dc + tot.snags + avg.snag.dbh + soil.ph, data = df1, dist = "negbin")
summary(hurdle_nb1)
```


```{r stepwise-aic-hurdle-nb1}
stepAIC(hurdle_nb1, direction = "both")
```

```{r hurdle-nb2}
hurdle_nb2 <- hurdle(n_ind ~ canopy.cover + avg.snag.dbh, data = df1, dist = "negbin")
summary(hurdle_nb2)
```

#### Hurdle model with forest type interaction
```{r hurdle-nb3}
hurdle_nb3 <- hurdle(n_ind ~ ft + ts + ba + st.ha + canopy.cover + cwd.con + vcwd.con + avg.dc + tot.snags + avg.snag.dbh + soil.ph + ft*ts + ts*ba + ts*soil.ph + ft*ba + ft*soil.ph, data = df1, dist = "negbin")
summary(hurdle_nb3)
```

```{r stepwise-aic-hurdle-nb3}
stepAIC(hurdle_nb3, direction = "both")
```
`n_ind` ~ `canopy.cover` + `avg.snag.dbh` still gives the lowest AIC -- this will be our final model.

```{r plot-nb2-hurdle-partial}
plot_nb2_hurdle <- df %>%
  mutate(presence = case_when(n_ind >= 1 ~ 1, n_ind == 0 ~ 0)) %>%
  ggplot(aes(x = canopy.cover, y = presence)) +
  geom_jitter(height = 0.02, alpha = 0.25) +
  geom_smooth(method = "glm", method.args = list(family="binomial"), se = TRUE, fullrange = TRUE) +
  xlim(60,120) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  labs(x = "",
       y = "")

plot_nb2_count <- df %>%
  filter(n_ind > 0) %>%
  ggplot(aes(x = canopy.cover, y = n_ind)) +
  geom_jitter(alpha = 0.5) +
  stat_smooth(method = MASS::glm.nb, se = TRUE, fullrange = TRUE) +
  xlim(70,100) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  labs(x = "Percent canopy cover",
       y = "Abundance per cover board")

main.plot <- plot_nb2_count

inset.plot <- plot_nb2_hurdle

hurdle_plot <-
  ggdraw() +
  draw_plot(main.plot) +
  draw_plot(inset.plot, x = 0.055, y = .58, width = .4, height = .4)

hurdle_plot

ggsave("hurdle_nb2_plot.png")
```

#### Hurdle model with multiple interactions
```{r hurdle-nb4}
hurdle_nb4 <- hurdle(n_ind ~ ft + ts + ba + st.ha + canopy.cover + cwd.con + vcwd.con + avg.dc + tot.snags + avg.snag.dbh + soil.ph + ft*ts + ts*ba + ts*soil.ph + ft*ba + ft*soil.ph + cwd.con * vcwd.con + st.ha * canopy.cover, data = df1, dist = "negbin")
summary(hurdle_nb4)
```
```{r stepwise-aic-hurdle-nb4}
stepAIC(hurdle_nb4, direction = "both")
```
Adding additional interaction terms does not improve the model.

```{r aic-comp-models}
library(AICcmodavg)
models <- list(hurdle_nb1, hurdle_nb2, hurdle_nb3, hurdle_nb4)
mod.names <- c('Env model full', 'Final model', 'Env model ft interaction', 'Env model mult interactions')
aic_table <- aictab(cand.set = models, modnames = mod.names)
aic_table
```

```{r table-aic-comp}
#install.packages("knitr")
library(knitr)
```
```{r}
kable(aic_table, col.names = c('Model', 'K', 'AIC', 'Delta AIC', 'Model Lik', 'AIC Wt', 'LL', 'Cum Wt'))
```

## P. cinereus Morphometrics
First need to add forest type to the `pc` dataframe so that morphometrics are associated with different sites.  I don't need to join dataframes here, since I can simply extract the forest type information from the `plot` variable.  Note that there are 250 observations in the `pc` datafile, while there are only 241 detections of P. cinereus in the `aco` dataframe that I have used so far in this analysis.  I could not determine the source of this issue, so I'm chosing simply to analyize them separately.

```{r add-ft-var-pc}
pc <- pc %>%
  mutate(ft = str_extract(plot, "(?<=.)TS|MD"))

pc
```

#### By sex
```{r morpho-density-by-sex}
wt_plot <- pc %>%
  drop_na(sex) %>%
  ggplot(aes(x = wt, fill = sex)) +
  geom_density(alpha = 0.5) +
  labs(x = "Weight (cg)",
       y = "",
       fill = "Sex") +
  theme(legend.position = c(0.96, 0.8)) +
  theme(legend.title = element_blank()) +
  scale_fill_viridis_d()

tl_plot <- pc %>%
  drop_na(sex) %>%
  ggplot(aes(x = tl, fill = sex)) +
  geom_density(alpha = 0.5) +
  labs(x = "Total length (mm)",
       y = "Density") +
  theme(legend.position = "none") +
  scale_fill_viridis_d()

svl_plot <- pc %>%
  drop_na(sex) %>%
  ggplot(aes(x = svl, fill = sex)) +
  geom_density(alpha = 0.5) +
  labs(x = "Snout-vent length (mm)",
       y = "") +
  theme(legend.position = "none")  +
  scale_fill_viridis_d()

density_morpho_by_sex <- grid.arrange(wt_plot, tl_plot, svl_plot, top = textGrob("P. cinereus morphometrics by sex"))

ggsave("density_morpho_by_sex.png",plot = density_morpho_by_sex)
```

Density distributions for Plethodon cinereus weight (in centigrams), total and snout-vent length (in millimeters).  Females appear to be somewhat heavier and longer than males.  Observations with missing values removed.  Skew in total length but not snout-vent length may be due to salamanders with missing/regenerating tails.

These morphometric variables are normally distributed, so we can use t-tests.

```{r t-test-wt-sex}
t.test(wt ~ sex, data = pc)
```
```{r t-test-tl-sex}
t.test(tl ~ sex, data = pc)
```
```{r t-test-svl-sex}
t.test(svl ~ sex, data = pc)
```
Female P. cinereus were significantly heavier than males (T(129.95) = 2.35, P = 0.02).  Females were also significantly longer than males, both in total length (T(122.62) = 2.17, P = 0.032), and snout-vent length (T(114.74) = 2.38, P = 0.019).

```{r boxplot-morpho-sex}
box1 <- pc %>%
  drop_na(sex) %>%
  ggplot(aes(x = sex, y = wt, fill = sex)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, alpha = 0.1) +
  labs(x = "",
       y = "Weight (cg)") +
  scale_fill_manual(values = c("wheat", "lavender")) +
  theme_bw() +
  theme(legend.position = "none") +
  annotate("text", x = 2.1, y = 162, label = "P = 0.02")

box2 <- pc %>%
  drop_na(sex) %>%
  ggplot(aes(x = sex, y = tl, fill = sex)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, alpha = 0.1) +
  labs(x = "", 
       y = "Total length (mm)") +
  scale_fill_manual(values = c("wheat", "lavender")) +
  theme_bw() +
  theme(legend.position = "none") +
  annotate("text", x = 2.1, y = 99, label = "P = 0.032")

box3 <- pc %>%
  drop_na(sex) %>%
  ggplot(aes(x = sex, y = svl, fill = sex)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, alpha = 0.1) +
  labs(x = "",
       y = "Snout-vent length (mm)") +
  scale_fill_manual(values = c("wheat", "lavender")) +
  theme_bw() +
  theme(legend.position = "none") +
  annotate("text", x = 2.1, y = 56, label = "P = 0.019")

boxplot_morpho_by_sex <- grid.arrange(box1, box2, box3, ncol = 3, top = textGrob("P. cinereus morphometrics by sex"), bottom = textGrob("Sex"))

ggsave("boxplot_morpho_by_sex.png", plot = boxplot_morpho_by_sex)
```

#### By forest type
```{r t-test-wt-ft}
t.test(wt ~ ft, data = pc)
```
```{r t-test-tl-ft}
t.test(tl ~ ft, data = pc)
```

```{r t-test-svl-ft}
t.test(svl ~ ft, data = pc)
```
Report: P. cinereus are significantly heavier (T(205.86) = -1.7457, P = 0.082), and longer, both in total length (T(203.25) = -2.32, P = 0.022) and snout-vent length (T(198.56) = -2.13, P = 0.035), in hemlock-dominated forests than in mixed deciduous forests.  Variability in weight was greater in mixed deciduous forests.

```{r boxplot-morpho-ft, warning = FALSE}
box1 <- pc %>%
  ggplot(aes(x = ft, y = wt, fill = ft)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, alpha = 0.1) +
  labs(x = "",
       y = "Weight (cg)") +
  theme_bw() +
  theme(legend.position = "none") +
  annotate("text", x = 2.1, y = 162, label = "P = 0.082")

box2 <- pc %>%
  ggplot(aes(x = ft, y = tl, fill = ft)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, alpha = 0.1) +
  labs(x = "", 
       y = "Total length (mm)") +
  theme_bw() +
  theme(legend.position = "none") +
  annotate("text", x = 2.1, y = 99, label = "P = 0.022")

box3 <- pc %>%
  ggplot(aes(x = ft, y = svl, fill = ft)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, alpha = 0.1) +
  labs(x = "",
       y = "Snout-vent length (mm)") +
  theme_bw() +
  theme(legend.position = "none") +
  annotate("text", x = 2.1, y = 56, label = "P = 0.035")

boxplot_morpho_by_ft <- grid.arrange(box1, box2, box3, ncol = 3, top = textGrob("P. cinereus morphometrics by forest type"), bottom = textGrob("Forest type"))

ggsave("boxplot_morpho_by_ft.png", plot = boxplot_morpho_by_ft)
```

#### Cluster Analysis
Compare total length, snout-vent length, and weight between sexes of P. cinereus
```{r load-cluster-packages}
#install.packages("cluster")
#install.packages("factoextra")
library(cluster)
library(factoextra)
```

```{r calculate k-means}
pc_morpho <- pc %>%
  dplyr::select(tl, svl, wt, sex) %>%
  drop_na(sex) %>%
  mutate(across(c(tl, svl, wt), scale)) %>% # Try with and without this line
  drop_na()

pc_means <- pc_morpho %>%
  dplyr::select(-sex)

k2 <- kmeans(pc_means, centers = 2, nstart = 25)
k3 <- kmeans(pc_means, centers = 3, nstart = 25)

## Calculate k4 and k5

k4 <- kmeans(pc_means, centers = 4, nstart = 25)
k5 <- kmeans(pc_means, centers = 5, nstart = 25)
```
Have to use `dplyr::select` because the `select` function is overwritten by another package.

```{r view-k2}
k2
```


```{r plot-k-means}
p1 <- fviz_cluster(k2, geom = "point", data = pc_means) + ggtitle("k = 2")
p2 <- fviz_cluster(k3, geom = "point",  data = pc_means) + ggtitle("k = 3")
p3 <- fviz_cluster(k4, geom = "point",  data = pc_means) + ggtitle("k = 4")
p4 <- fviz_cluster(k5, geom = "point",  data = pc_means) + ggtitle("k = 5")

grid.arrange(p1, p2,  p3, p4, nrow = 2)
```

```{r elbow-plot-k-means}
fviz_nbclust(pc_means, kmeans, method = "wss")

ggsave("elbow-plot-k-means.png")
```

```{r compare-k2-sex}
final <- k2

pc_means %>%
  mutate(sex = pc_morpho$sex,
  cluster = final$cluster) %>%
  group_by(cluster, sex) %>%
  summarize(count = n()) %>%
  ggplot() +
  geom_col(aes(x = sex, y = count, fill = as.factor(cluster)), color = "black") +
  scale_fill_manual(values = c("skyblue", "red4")) +
  coord_flip() +
  labs(x = "Sex",
       y = "Count",
       fill = "Cluster")

ggsave("barplot-comp-k2-sex.png")
```

Try this by forest type / site.

```{r calc-k-means-ft}
pc_morpho_ft <- pc %>%
  dplyr::select(tl, svl, wt, ft) %>%
  drop_na(ft) %>%
  mutate(across(c(tl, svl, wt), scale)) %>% # Try with and without this line
  drop_na()

pc_means_ft <- pc_morpho_ft %>%
  dplyr::select(-ft)

k2 <- kmeans(pc_means_ft, centers = 2, nstart = 25)
k3 <- kmeans(pc_means_ft, centers = 3, nstart = 25)

## Calculate k4 and k5

k4 <- kmeans(pc_means_ft, centers = 4, nstart = 25)
k5 <- kmeans(pc_means_ft, centers = 5, nstart = 25)
```

```{r plot-k-means-ft}
p1 <- fviz_cluster(k2, geom = "point", data = pc_means_ft) + ggtitle("k = 2")
p2 <- fviz_cluster(k3, geom = "point",  data = pc_means_ft) + ggtitle("k = 3")
p3 <- fviz_cluster(k4, geom = "point",  data = pc_means_ft) + ggtitle("k = 4")
p4 <- fviz_cluster(k5, geom = "point",  data = pc_means_ft) + ggtitle("k = 5")


grid.arrange(p1, p2,  p3, p4, nrow = 2)
```

```{r elbow-plot-k-means-ft}
fviz_nbclust(pc_means_ft, kmeans, method = "wss")

```
Seems like k = 2 probably is the better fit here.

```{r compare-k2-ft}
final <- k2

pc_means_ft %>%
  mutate(ft = pc_morpho_ft$ft,
  cluster = final$cluster) %>%
  group_by(cluster, ft) %>%
  summarize(count = n()) %>%
  ggplot() +
  geom_col(aes(x = ft, y = count, fill = as.factor(cluster))) +
  coord_flip() +
  labs(fill = "Cluster")
```
Definitely does not capture forest type well, which makes me wonder what other covariates might account for the clustering -- perhaps something not even in the data?

## Biodiversity
```{r load-herps-df}
herps <- read_csv("/cloud/project/data/hf131-06-herps.csv")

herps <- herps %>%
  mutate(herp_species = species)

herps %>%
  count(herp_species)
```
We also have 241 observations of individual P. cinereus we need to add here as well as check to see if there are any instances of multiple individuals of other herps in one observation.  Add PLCI to species with case_when or if_else.

```{r herps-check-mult-entries}
herps %>%
  filter(str_detect(osn, ","))
```
No commas in the unique identifiers assigned to other herp species, so we can assume there are no cases of multiple individuals per observation.

There is no variable for forest type assigned in the `herps` dataframe, so I will assign it based on the the plot code.

```{r herps-add-ft-var}
herps <- herps %>%
  mutate(ft = str_extract(plot, "(?<=.)TS|MD"))

herps
```

Below I am ungrouping all P. cinereus observations stored in `df$n_ind` and filtering only for values not equal to zero, which gives us a new dataframe which is 241 rows long.  Then I'm adding a new column called `herp_species` which only has one value (PLCI), since all individuals here are P. cinereus.

```{r create-pc-obs-df}
pc_obs <- df %>%
  uncount(n_ind)

pc_obs$herp_species = "PLCI"

pc_obs
```
241 rows all labeled by species (PLCI = Plethodon cinereus).

```{r join-pc_obs-herps}
sp <- full_join(pc_obs, herps)

#sp <- sp %>%
#  dplyr::select(ft, herp_species)

# Couldn't get select to work here due to the joining variables in the previous step.
sp <- sp[c('ft', 'herp_species')]
sp
```

```{r count-herp_species}
sp %>%
  group_by(herp_species) %>%
  count(herp_species) %>%
  arrange(desc(n))
```
```{r}
sp %>%
  filter(ft == "TS") %>%
  group_by(herp_species) %>%
  count(herp_species) %>%
  arrange(desc(n))
  
sp %>%
  filter(ft == "MD") %>%
  group_by(herp_species) %>%
  count(herp_species) %>%
  arrange(desc(n))
```

```{r count-herp_species-by-ft}
sp %>%
  group_by(ft) %>%
  count(herp_species) %>%
  arrange(herp_species)
```
Looks like all amphibian species were detected more frequently in hemlock stands than mixed deciduous; only the two snake species were more frequently detected in mixed deciduous stands.  Since snakes are a separate taxonomic group and are only found in one habitat, we will remove them for analyzing biodiversity.

```{r create-amph-df}
amph <- sp %>%
  filter(herp_species %in% c("AMMA", "PLCI", "NOVI", "EUBI", "RASY"))

amph
```

```{r split-amph-by-ft}
md <- amph %>%
  filter(ft == "MD")

md

ts <- amph %>%
  filter(ft == "TS")

ts
```

```{r create-richness-list}
md_matrix <- matrix(table(md))
md_abund <- as.abucount(md_matrix)
glimpse(md_abund)

ts_matrix <- matrix(table(ts))
ts_abund <- as.abucount(ts_matrix)
glimpse(ts_abund)

richness_list <- list(md_abund, ts_abund)
```

```{r calc-sp-richness}
richness <- iNEXT(richness_list, q = 0, datatype = "abundance")
richness
```

```{r plot-rarefaction-sp-richness}
ggiNEXT(richness, type=1, facet.var = "None", color.var = "Assemblage") +
  scale_color_discrete(name = "None", labels = c("Mixed deciduous", "Hemlock")) +
  scale_shape_discrete(name = "None", labels = c("Mixed deciduous", "Hemlock")) +
  scale_fill_discrete(name = "None", labels = c("Mixed deciduous", "Hemlock")) +
  labs(caption = "Amphibian species only")

ggsave("sp_richness_amph.png")
```

Not particularly meaningful due to small sample size and sampling design targeted to detect P. cinereus, but it does suggest that amphibian biodiversity may be higher in hemlock stands.
