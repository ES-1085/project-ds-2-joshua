---
title: "Red-backed salamander abundance and distribution in north-central Massachusetts"
author: "Joshua A. Harkness"
date: "2024-02-13"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#install.packages(gridExtra)
library(tidyverse)
library(broom)
library(stringr)
library(sf)
library(ggspatial)
library(readxl)
library(GGally)
library(gridExtra)
library(tidymodels)
library(MASS)
library(simfit)
library(ggpmisc)
library(iNEXT)
library(pscl)
```

## Load Data
```{r load-datafiles}
plots <- read_csv("/cloud/project/data/hf131-01-plot.csv")
aco <- read_csv("/cloud/project/data/hf131-04-aco.csv")
pc <- read_csv("/cloud/project/data/hf131-05-pc-abund.csv")
herps <- read_csv("/cloud/project/data/hf131-06-herps.csv")
```
```{r}
aco <- aco %>%
  dplyr::select(plot, asn, aco, pca, osn, other.sp)
```

```{r}
n_distinct(aco$aco)
```

```{r}
aco_abund <- aco %>%
  group_by(plot, asn, aco) %>%
  summarize(n_pc = sum(pca), .groups = "keep")

aco_abund
```
Still getting 241 detections of P. cinereus, but when grouping by `plot` and `asn`, we get 310 cover board observations instead of the original 300 -- not sure why it's doing this, but presumbly it's only adding a ten zeros to the dataframe, so I'm going to let it go at that.

```{r}
df <- left_join(aco_abund, plots)
df
```
```{r}
glimpse(df)
sum(df$n_pc)
```
Now 310 cover board observations, still with 241 P. cinereus detections.
```{r}
unique(df$n_pc)
```

```{r}
df %>%
  ggplot(aes(x = ft, y = n_pc, fill = ft)) +
  geom_violin() +
  labs(title = "P. cinereus abundance by forest type",
       x = "Forest type",
       y = "Mean abundance per cover board") +
  theme(legend.position = "none") +
  scale_x_discrete(labels = c("Mixed deciduous", "Hemlock"))
```

```{r}
df %>%
  group_by(ft) %>%
  summarise(mean = mean(n_pc),
            sd = sd(n_pc),
            n = n(),
            SE = sd(n_pc) / sqrt(n())) %>%
  ggplot(aes(x = ft, y = mean)) +
  geom_point(shape = 15, size = 3) +
  geom_errorbar(aes(ymin = mean - SE, ymax = mean + SE), width = 0.2) +
  labs(title = "P. cinereus abundance by forest type",
       x = "Forest type",
       y = "Mean abundance per cover board") +
  scale_x_discrete(labels = c("Mixed deciduous", "Hemlock")) +
  theme_classic()
```

  ggplot(aes(x = ft, y = mean_n)) +
  geom_errorbar(ymin = mean_n - sd_n, ymax = mean_n + sd_n, width = 3)
```





### Modeling
Using negative binomial framework here as it provided the lowest AICs in model testing, given highly skewed count data with variance not equal to mean.  Quasi-Poisson may also be applicable here.

#### Environmental Model with no interaction effects (negative binomial)
```{r}
nb_env <- glm.nb(n_ind ~ ft + ts + ba + st.ha + canopy.cover + cwd.con + vcwd.con + avg.dc + soil.ph + airt + rh + soilt, data = df_pc)
summary(nb_env)
```
#### Environmental model with forest type interaction (negative binomial)

```{r}
nb_env_effect1 <- glm.nb(n_ind ~ ft * ts * ba * vcwd.con * cwd.con * st.ha + canopy.cover + cwd.con + vcwd.con + avg.dc + soil.ph + airt + rh + soilt, data = df_pc)
summary(nb_env_effect1)
```

#### Hurdle model
```{r}
#install.packages("pscl")
library(pscl)

nb_hurdle1 <- hurdle(n_ind ~ ft + ts + ba + st.ha + canopy.cover + cwd.con + vcwd.con + avg.dc + soil.ph + airt + rh + soilt, data = df_pc, dist = "negbin")
summary(nb_hurdle1)
```

#### Compare AIC
```{r}
library(AICcmodavg)
models <- list(nb_env, nb_env_effect1)
mod.names <- c('Environmental model NB', 'Environmental model with interaction NB')
aictab(cand.set = models, modnames = mod.names)
```

```{r}
models <- list(nb_hurdle1)
mod.names <- c('Environmental model Hurdle NB')
aictab(cand.set = models, modnames = mod.names)
```
Interesting, lowest AIC is the environmental model with forest type interaction effects, negative binomial (without hurdle).  The hurdle model has a Delta AIC of 239.67.  Hurdle model simply being penalized more for the hurdle component?  Not an appropriate comparison using AIC?


#### Are P. cinereus more abundant in hemlock or mixed deciduous forests?
```{r}
df_pc %>%
  ggplot(aes(x = ft, y = n_ind, fill = ft)) +
  geom_violin() +
  theme_classic() +
  scale_x_discrete(labels = c("Mixed deciduous", "Hemlock")) +
  labs(x = "Forest type",
       y = "P. cinereus counts") +
  theme(legend.position = "none")
```
Wilcoxon-signed rank test since response variable is not normally distributed.
```{r}
wilcox.test(df_pc$n_ind ~ df_pc$ft)
```
Mean P. cinereus abundance is significantly higher in hemlock-dominated stands than in mixed-deciduous stands (Wilcoxon rank sum test, W = 1676, P = <0.001).

```{r}
df_pc %>%
  ggplot(aes(x = ts, y = n_ind)) +
  geom_jitter(alpha = 0.25) +
  geom_smooth(method = "lm")
```
Simple linear model is not a good fit, so we'll also try this with a negative binomial regression.

```{r}
nb1 <- glm.nb(n_ind ~ ts, data = df_pc)
summary(nb1)
pred.plot(nb1, xpred = "ts") +
  labs(x = "Percent hemlock basal area (m2/ha)",
       y = "P. cinereus count")
```
```{r}
glance(nb1)
```


```{r}
nb_cwd <- glm.nb(n_ind ~ vcwd.con, data = df_pc)
summary(nb_cwd)
pred.plot(nb_cwd, xpred = "vcwd.con") +
  labs(x = "CWD volume in contact with ground",
       y = "P. cinereus count")
```


## P. cinereus Morphometrics

```{r}
wt_plot <- df_pc %>%
  drop_na(sex) %>%
  ggplot(aes(x = wt, fill = sex)) +
  geom_density(alpha = 0.5) +
  labs(title = "P. cinereus morphometrics by sex",
       x = "Weight (cg)",
       y = "",
       fill = "Sex") +
  theme(legend.position = c(0.96, 0.85)) +
  theme(legend.title = element_blank()) +
  scale_fill_viridis_d()

tl_plot <- df_pc %>%
  drop_na(sex) %>%
  ggplot(aes(x = tl, fill = sex)) +
  geom_density(alpha = 0.5) +
  labs(x = "Total length (mm)",
       y = "Density") +
  theme(legend.position = "none") +
  scale_fill_viridis_d()

svl_plot <- df_pc %>%
  drop_na(sex) %>%
  ggplot(aes(x = svl, fill = sex)) +
  geom_density(alpha = 0.5) +
  labs(x = "Snout-vent length (mm)",
       y = "") +
  theme(legend.position = "none")  +
  scale_fill_viridis_d()

grid.arrange(wt_plot, tl_plot, svl_plot)

#  ggpairs(aes(color = sex), columns = c("wt", "tl", "svl"))
```

Density distributions for Plethodon cinereus weight (in centigrams), total and snout-vent length (in millimeters).  Females appear to be somewhat heavier and longer than males.  Observations with missing values removed.  Skew in total length but not snout-vent length may be due to salamanders with missing/regenerating tails.

```{r boxplot-morpho-sex}
box1 <- df_pc %>%
  drop_na(sex) %>%
  ggplot(aes(x = sex, y = wt, fill = sex)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, alpha = 0.1) +
  labs(x = "",
       y = "Weight (cg)") +
  scale_fill_manual(values = c("darkseagreen2", "lavender")) +
  theme_bw() +
  theme(legend.position = "none") +
  annotate("text", x = 2.1, y = 162, label = "P < 0.001")

box2 <- df_pc %>%
  drop_na(sex) %>%
  ggplot(aes(x = sex, y = tl, fill = sex)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, alpha = 0.1) +
  labs(x = "", 
       y = "Total length (mm)") +
  scale_fill_manual(values = c("wheat", "lavender")) +
  theme_bw() +
  theme(legend.position = "none") +
  annotate("text", x = 2.1, y = 99, label = "P < 0.001")

box3 <- df_pc %>%
  drop_na(sex) %>%
  ggplot(aes(x = sex, y = svl, fill = sex)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, alpha = 0.1) +
  labs(x = "",
       y = "Snout-vent length (mm)") +
  scale_fill_manual(values = c("wheat", "lavender")) +
  theme_bw() +
  theme(legend.position = "none") +
  annotate("text", x = 2.1, y = 56, label = "P < 0.001")

grid.arrange(box1, box2, box3, ncol = 3, top = textGrob("P. cinereus morphometrics by sex"), bottom = textGrob("Sex"))
```

Normally distributed, so we can use a T-test or simple linear model.

T-test first:
```{r}
t.test(wt ~ sex, data = df_pc)
```

I will also run T-tests for total length and snout-vent length as a function of sex.
```{r}
t.test(tl ~ sex, data = df_pc)
```
```{r}
t.test(svl ~ sex, data = df_pc)
```
Female P. cinereus are significantly heavier than males; total length and snout-vent length were also significantly longer in females than males.

#### By forest type
```{r boxplot-morpho-ft, warning = FALSE}
box1 <- df_pc %>%
  ggplot(aes(x = ft, y = wt, fill = ft)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, alpha = 0.1) +
  labs(x = "",
       y = "Weight (cg)") +
  theme_bw() +
  theme(legend.position = "none") +
  annotate("text", x = 2.1, y = 162, label = "P = 0.069")

box2 <- df_pc %>%
  ggplot(aes(x = ft, y = tl, fill = ft)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, alpha = 0.1) +
  labs(x = "", 
       y = "Total length (mm)") +
  theme_bw() +
  theme(legend.position = "none") +
  annotate("text", x = 2.1, y = 99, label = "P = 0.089")

box3 <- df_pc %>%
  ggplot(aes(x = ft, y = svl, fill = ft)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, alpha = 0.1) +
  labs(x = "",
       y = "Snout-vent length (mm)") +
  theme_bw() +
  theme(legend.position = "none") +
  annotate("text", x = 2.1, y = 56, label = "P = 0.398")

grid.arrange(box1, box2, box3, ncol = 3, top = textGrob("P. cinereus morphometrics by forest type"), bottom = textGrob("Forest type"))
```

```{r}
t.test(wt ~ ft, data = df_pc)
wilcox.test(df_pc$wt ~ df_pc$ft)
```
No significant difference in mean weight between mixed deciduous and hemlock-dominated stands.

```{r}
t.test(tl ~ ft, data = df_pc)
wilcox.test(df_pc$tl ~ df_pc$ft)
```
No significant difference in mean total length between mixed deciduous and hemlock stands.

```{r}
t.test(svl ~ ft, data = df_pc)
wilcox.test(df_pc$svl ~ df_pc$ft)
```
No significant difference in mean snout-vent length between mixed deciduous and hemlock forests.

We can also model this with the continuous variable `ts` instead of categorical `ft`.
```{r}
lm_wt_ts <- linear_reg(engine = "lm") %>%
  fit(wt ~ ts, data = df_pc)

lm_wt_ts_tidy <- lm_wt_ts %>%
  tidy()

lm_wt_ts_tidy

glance(lm_wt_ts)
```
Not significant with very low R^2.

```{r}
lm_tl_ts <- linear_reg(engine = "lm") %>%
  fit(tl ~ ts, data = df_pc)

lm_tl_ts_tidy <- lm_tl_ts %>%
  tidy()

lm_tl_ts_tidy

glance(lm_tl_ts)
```
Significant (P = 0.02), but note very low R^2 (0.0089).

```{r}
lm_svl_ts <- linear_reg(engine = "lm") %>%
  fit(svl ~ ts, data = df_pc)

lm_svl_ts_tidy <- lm_svl_ts %>%
  tidy()

lm_svl_ts_tidy

glance(lm_svl_ts)
```
Also significant (P = 0.02), again with very low R^2 (0.0088).

#### Cluster Analysis
Compare total length, snout-vent length, and weight between sexes of P. cinereus
```{r}
#install.packages("cluster")
#install.packages("factoextra")
library(cluster)
library(factoextra)
```

```{r}
pc_morpho <- df_pc %>%
  dplyr::select(tl, svl, wt, sex) %>%
  drop_na(sex) %>%
  mutate(across(c(tl, svl, wt), scale)) %>% # Try with and without this line
  drop_na()

pc_means <- pc_morpho %>%
  dplyr::select(-sex)

k2 <- kmeans(pc_means, centers = 2, nstart = 25)
k3 <- kmeans(pc_means, centers = 3, nstart = 25)

## Calculate k4 and k5

k4 <- kmeans(pc_means, centers = 4, nstart = 25)
k5 <- kmeans(pc_means, centers = 5, nstart = 25)
```
Have to use `dplyr::select` because the `select` function is overwritten by another package.

```{r}
k2
```


```{r}
p1 <- fviz_cluster(k2, geom = "point", data = pc_means) + ggtitle("k = 2")
p2 <- fviz_cluster(k3, geom = "point",  data = pc_means) + ggtitle("k = 3")
p3 <- fviz_cluster(k4, geom = "point",  data = pc_means) + ggtitle("k = 4")
p4 <- fviz_cluster(k5, geom = "point",  data = pc_means) + ggtitle("k = 5")


grid.arrange(p1, p2,  p3, p4, nrow = 2)
p1
```

```{r}
fviz_nbclust(pc_means, kmeans, method = "wss")
```

```{r}
final <- k2

pc_means %>%
  mutate(sex = pc_morpho$sex,
  cluster = final$cluster) %>%
  group_by(cluster, sex) %>%
  summarize(count = n()) %>%
  ggplot() +
  geom_col(aes(x = sex, y = count, fill = as.factor(cluster)), color = "black") +
  scale_fill_manual(values = c("skyblue", "red4")) +
  coord_flip() +
  labs(x = "Sex",
       y = "Count",
       fill = "Cluster")
```

Try this by forest type / site.

```{r}
pc_morpho_ft <- df_pc %>%
  dplyr::select(tl, svl, wt, ft) %>%
  drop_na(ft) %>%
  mutate(across(c(tl, svl, wt), scale)) %>% # Try with and without this line
  drop_na()

pc_means_ft <- pc_morpho_ft %>%
  dplyr::select(-ft)

k2 <- kmeans(pc_means_ft, centers = 2, nstart = 25)
k3 <- kmeans(pc_means_ft, centers = 3, nstart = 25)

## Calculate k4 and k5

k4 <- kmeans(pc_means_ft, centers = 4, nstart = 25)
k5 <- kmeans(pc_means_ft, centers = 5, nstart = 25)
```

```{r}
p1 <- fviz_cluster(k2, geom = "point", data = pc_means_ft) + ggtitle("k = 2")
p2 <- fviz_cluster(k3, geom = "point",  data = pc_means_ft) + ggtitle("k = 3")
p3 <- fviz_cluster(k4, geom = "point",  data = pc_means_ft) + ggtitle("k = 4")
p4 <- fviz_cluster(k5, geom = "point",  data = pc_means_ft) + ggtitle("k = 5")


grid.arrange(p1, p2,  p3, p4, nrow = 2)
```

```{r}
fviz_nbclust(pc_means_ft, kmeans, method = "wss")
```
Seems like k = 2 probably is the better fit here.

```{r}
final <- k2

pc_means_ft %>%
  mutate(ft = pc_morpho_ft$ft,
  cluster = final$cluster) %>%
  group_by(cluster, ft) %>%
  summarize(count = n()) %>%
  ggplot() +
  geom_col(aes(x = ft, y = count, fill = as.factor(cluster))) +
  coord_flip() +
  labs(fill = "Cluster")
```

## Biodiversity
```{r}
herps <- read_csv("/cloud/project/data/hf131-06-herps.csv")

herps <- herps %>%
  mutate(herp_species = species)

herps %>%
  count(herp_species)
```
We also have 323 observations of individual P. cinereus we need to add here as well as check to see if there are any instances of multiple individuals of other herps in one observation.  Add PLCI to species with case_when or if_else.

```{r}
herps %>%
  filter(str_detect(osn, ","))
```
No commas in the unique identifiers assigned to other herp species, so we can assume there are no cases of multiple individuals per observation.

There is no variable for forest type assigned in the `herps` dataframe, so I will assign it based on the the plot code.

```{r}
herps <- herps %>%
  mutate(ft = str_extract(plot, "(?<=.)TS|MD"))

herps
```

I need to duplicate these rows with `pca` > 1 by the conditional value of `pca` so that each row is one individual P. cinereus observation.

`uncount` seems to work here.

```{r}
pc_obs <- df %>%
  uncount(pca)

pc_obs$herp_species = "PLCI"

pc_obs
```
323 rows all labeled by species (PLCI = Plethodon cinereus).

```{r}
sp <- full_join(pc_obs, herps)

sp <- sp %>%
  dplyr::select(ft, herp_species)
sp
```

```{r}
sp %>%
  count(herp_species) %>%
  arrange(desc(n))
```

```{r}
sp %>%
  group_by(ft) %>%
  count(herp_species) %>%
  arrange(herp_species)
```
Looks like all amphibian species were detected more frequently in hemlock stands than mixed deciduous; only the two snake species were more frequently detected in mixed deciduous stands.  Since snakes are a separate taxonomic group and are only found in one habitat, they are adding noise to the analysis.  We will remove them for analyzing biodiversity.

```{r}
amph <- sp %>%
  filter(herp_species %in% c("AMMA", "PLCI", "NOVI", "EUBI", "RASY"))

amph
```


```{r}
md <- amph %>%
  filter(ft == "MD")

md

ts <- amph %>%
  filter(ft == "TS")

ts
```

```{r create-richness-list}
md_matrix <- matrix(table(md))
md_abund <- as.abucount(md_matrix)
glimpse(md_abund)

ts_matrix <- matrix(table(ts))
ts_abund <- as.abucount(ts_matrix)
glimpse(ts_abund)

richness_list <- list(md_abund, ts_abund)
```

```{r}
richness <- iNEXT(richness_list, q = 0, datatype="abundance")
richness
```
```{r}
ggiNEXT(richness, type=1, facet.var = "None", color.var = "Assemblage") +
  scale_color_discrete(name = "None", labels = c("Mixed deciduous", "Hemlock")) +
  scale_shape_discrete(name = "None", labels = c("Mixed deciduous", "Hemlock")) +
  scale_fill_discrete(name = "None", labels = c("Mixed deciduous", "Hemlock")) +
  labs(caption = "Amphibian species only")
```

Not particularly meaningful due to small sample size and sampling design targeted to detect P. cinereus, but it does suggest that amphibian biodiversity may be higher in hemlock stands.
