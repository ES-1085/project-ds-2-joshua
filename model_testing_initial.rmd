---
title: "Red-backed salamander abundance and distribution in north-central Massachusetts"
author: "Joshua A. Harkness"
date: "2024-02-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#install.packages(gridExtra)
library(tidyverse)
library(broom)
library(stringr)
library(sf)
library(ggspatial)
library(readxl)
library(GGally)
library(gridExtra)
library(tidymodels)
```
```{r}
df <- read_csv("/cloud/project/data/df.csv")
```

```{r}
df %>%
  ggplot(aes(x = aco, y = pca)) +
  geom_jitter(alpha = 0.01)
```
No more than 3 P. cinereus were observed under a singe cover board during any one survey.  `geom_jitter` reveals some overlap -- that there are multiple identical counts (presumably accounting for repeated visits to the same cover board).  This explains why when grouped by `aco` (below) we find some cover boards have many more than 3 salamanders observed.

```{r}
pc_abund <- df %>%
  group_by(ft, site, plot, asn, aco) %>%
  count(pca, sort = TRUE) %>%
  summarise(n_ind = n*pca) %>%
  arrange(desc(n_ind))

pc_abund
```
```{r}
sum(pc_abund$n_ind)
```
323 total salamanders observed.

#### Abundance diff between forest types
```{r}
pc_abund_sum <- pc_abund %>%
  group_by(ft) %>%
  summarise(mean = mean(n_ind),
            sd = sd(n_ind),
            se = sd/sqrt(sum(n_ind)))

pc_abund_sum
```
```{r}
pc_abund_sum %>%
  ggplot(aes(x = ft, y = mean, fill = ft)) +
  geom_col(color = "black") +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se, width = 0.1)) +
  labs(x = "Forest Type", y = "Count per cover board")
```
```{r}
ggplot(pc_abund, aes(x = ft, y = n_ind, fill = ft)) +
  geom_violin()
```
Not normally distributed, highly right skewed, so we should use a non-parametric test -- Wilcoxon signed rank/Mann-Whitney U-test are applicable here.

```{r}
wilcox.test(n_ind ~ ft, data = pc_abund)
```
Mean abundance of P. cinereus is not significantly different (P > 0.05) between hemlock and mixed deciduous forest types.

Compare with lm

```{r}
lm1 <- linear_reg(engine = "lm") %>%
  fit(n_ind ~ ft, data = pc_abund) %>%
  tidy()

lm1
```

## Join dataframes
```{r}
df_pc <- left_join(df, pc_abund)
```
## Plot useful variables
```{r}
p1 <- ggplot(df_pc, aes(x = ba, y = n_ind)) +
  geom_jitter(alpha = 0.1) +
  geom_smooth(method = "lm") +
  labs(x = "Basal area (m2/ha)",
       y = "Count")
p2 <- ggplot(df_pc, aes(x = st.ha, y = n_ind)) +
  geom_jitter(alpha = 0.1) +
  geom_smooth(method = "lm") +
  labs(x = "Stems/ha",
       y = "Count")
p3 <- ggplot(df_pc, aes(x = ts, y = n_ind)) +
  geom_jitter(alpha = 0.1) +
  geom_smooth(method = "lm") +
  labs(x = "Percent hemlock",
       y = "Count")
p4 <- ggplot(df_pc, aes(x = canopy.cover, y = n_ind)) +
  geom_jitter(alpha = 0.1) +
  geom_smooth(method = "lm") +
  labs(x = "Percent canopy cover",
       y = "Count")
p5 <- ggplot(df_pc, aes(x = cwd.con, y = n_ind)) +
  geom_jitter(alpha = 0.1) +
  geom_smooth(method = "lm") +
  labs(x = "Number CWD pieces contact",
       y = "Count")
p6 <- ggplot(df_pc, aes(x = vcwd.con, y = n_ind)) +
  geom_jitter(alpha = 0.1) +
  geom_smooth(method = "lm") +
  labs(x = "Volume CWD contact",
       y = "Count")
p7 <- ggplot(df_pc, aes(x = avg.dc, y = n_ind)) +
  geom_jitter(alpha = 0.1) +
  geom_smooth(method = "lm") +
  labs(x = "Average decay class",
       y = "Count")
p8 <- ggplot(df_pc, aes(x = tot.snags, y = n_ind)) +
  geom_jitter(alpha = 0.1) +
  geom_smooth(method = "lm") +
  labs(x = "Total snags",
       y = "Count")
p9 <- ggplot(df_pc, aes(x = avg.snag.dbh, y = n_ind)) +
  geom_jitter(alpha = 0.1) +
  geom_smooth(method = "lm") +
  labs(x = "Average snag DBH",
       y = "Count")

grid.arrange(p1, p2, p3, p4, p5, p6, p7, p8, p9)
```
```{r}
ggplot(df_pc, aes(x = vcwd.con, y = n_ind)) +
  geom_point(alpha = 0.25)
```

```{r}
p10 <- ggplot(df_pc, aes(x = soil.ph, y = n_ind)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "Soil pH")
p11 <- ggplot(df_pc, aes(x = airt, y = n_ind)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "Air temp")
p12 <- ggplot(df_pc, aes(x = rh, y = n_ind)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "Relative humidity")
p13 <- ggplot(df_pc, aes(x = soilt, y = n_ind)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "Soil temp")

grid.arrange(p10, p11, p12, p13)
```


## Modeling

```{r}
lm2 <- linear_reg(engine = "lm") %>%
  fit(n_ind ~ avg.dc, data = df_pc)

lm2_tidy <- lm2 %>%
  tidy()

lm2_tidy
```

```{r}
glance(lm2)
```
```{r}
lm3 <- linear_reg(engine = "lm") %>%
  fit(n_log ~ avg.dc_log, data = df_pc)

lm3_tidy <- lm3 %>%
  tidy()

lm3_tidy
```

```{r}
glance(lm3)
```
#### GLM
```{r}
glm1 = glm(n_ind ~ avg.dc, data = df_pc)
summary(glm1)
```

#### Poisson
```{r}
pois1 = glm(n_ind ~ avg.dc, data = df_pc, family = "poisson")
summary(glm1)
```

#### Quasi-Poisson
```{r}
qpois1 = glm(n_ind ~ avg.dc, data = df_pc, family = "quasipoisson")
summary(glm1)
```
Maybe a good fit?  Resolves the overdispersion issue.

#### Negative binomial
```{r}
#install.packages("MASS")
#install.packages("simfit")
library(MASS)
library(simfit)
```

```{r}
nb1 <- glm.nb(n_ind ~ avg.dc, data = df_pc)
summary(nb1)
```
Best fit yet, other than possibly quasi-poisson.

```{r}
pred.plot(nb1, xpred = "avg.dc") +
  scale_y_continuous("Count", 
                     labels = function(x) format(x, scientific = FALSE)) +
  scale_x_continuous("Average decay class") +
  theme_bw(14)
```


#### Quadratic

First simple linear model
```{r}
lm3 <- linear_reg(engine = "lm") %>%
  fit(n_ind ~ avg.dc, data = df_pc)

lm3_tidy <- lm3 %>%
  tidy()

lm3_tidy
```

```{r}
glance(lm3)
```

R squared isn't good (0.044), but better than I was expecting -- explains less than 5% of data.  AIC is also quite high.

```{r}
#Square average decay class to fit quadratic model
df_pc <- df_pc %>%
  mutate(avg.dc2 = avg.dc^2)
```

```{r}
lm3_quad <- linear_reg(engine = "lm") %>%
  fit(n_ind ~ avg.dc + avg.dc2, data = df_pc)

lm3_quad_tidy <- lm3_quad %>%
  tidy()

lm3_quad_tidy
```
```{r}
glance(lm3_quad)
```
AIC is hardly any lower.  Still not a good fit.


Plot quadratic model
```{r}
dc_values <- seq(0, 5, 0.1)

predictedcounts <- predict(lm3_quad, list(avg.dc = dc_values, avg.dc2 = dc_values^2))
```

```{r}
plot(df_pc$avg.dc, df_pc$n_ind, pch=16, xlab = "Decay class", ylab = "Counts", cex.lab = 1.3, col = "blue")
lines(dc_values, predictedcounts, col = "darkgreen", lwd = 3)
```
A little better, but still not a good fit (explains ~5% of data).  Problem seems to be heteroscedasticity.

I will try this for BA as well.

```{r}
#Square average decay class to fit quadratic model
df_pc <- df_pc %>%
  mutate(ba2 = ba^2)
```

```{r}
lm4_quad <- lm(n_ind ~ ba + ba2, data = df_pc)
summary(lm4_quad)
```

Plot quadratic model
```{r}
dc_values <- seq(0, 5, 0.1)

predictedcounts <- predict(lm3_quad, list(avg.dc = dc_values, avg.dc2 = dc_values^2))
```

```{r}
plot(df_pc$avg.dc, df_pc$n_ind, pch=16, xlab = "Decay class", ylab = "Counts", cex.lab = 1.3, col = "blue")
lines(dc_values, predictedcounts, col = "darkgreen", lwd = 3)
```

#### Multiple neg bionomials
Forest structure
```{r}
nb2 <- glm.nb(n_ind ~ ft + ba + st.ha + ts + canopy.cover, data = df_pc)
summary(nb2)
```
P. cinereus is significantly correlated with forest type (higher in hemlock stands), but is not significantly correlated with percent hemlock cover, suggesting that there is some effect of how the authors classified mixed deciduous vs hemlock forests.  Abundance is not significantly correlated with basal area, but is significantly correlated to stem density.


All environmental variables
```{r}
nb_env <- glm.nb(n_ind ~ ft + ba + st.ha + ts + canopy.cover + avg.dc + vcwd.con + cwd.con + tot.snags + avg.snag.dbh + soil.ph + soilt + airt + rh, data = df_pc)
summary(nb_env)
```
Consider interaction effects here; some of these variables are definitely not independent.

#### Logistic regression with presence/absence
```{r}
df_pc <- df_pc %>%
  mutate(presence = as.factor(case_when(n_ind >= 1 ~ 1, n_ind == 0 ~ n_ind)))
```

```{r}
df_pc %>%
  ggplot(aes(x = rh, y = presence)) +
  geom_jitter(height = 0.1, alpha = 0.25)
```
I think I'll use relative humidity for a logistic regression with one predictor, then I'll try multiple predictors.  Consider downsampling for presence and absence data.

```{r}
log_fit <- logistic_reg() %>%
  set_engine("glm") %>%
  fit(presence ~ rh, data = df_pc, family = "binomial")

log_fit_tidy <- log_fit %>%
  tidy()

log_fit_tidy
glance(log_fit)
```

Presence is significantly correlated with relative humidity, relationship is positive.  Need to plot this.

```{r}
log_fit2 <- logistic_reg() %>%
  set_engine("glm") %>%
  fit(presence ~ ba + canopy.cover + soil.ph + rh + soilt, data = df_pc, family = "binomial")

log_fit2_tidy <- log_fit2 %>%
  tidy()

log_fit2_tidy
glance(log_fit2)
```
Better fit than the presence ~ rh model.

#### Build model to predict presence/absence based on environmental variables

```{r}
set.seed(117)

abund_split <- initial_split(df_pc, prop = 0.8)

training_data <- training(abund_split)
testing_data <- testing(abund_split)
```

```{r}
glimpse(training_data)
glimpse(testing_data)
```
Consider downsampling here.

```{r}
log_fit_abund <- logistic_reg(engine = "glm") %>%
  fit(presence ~ ba + canopy.cover + soil.ph + rh + soilt, data = training_data, family = "binomial")

```

```{r}
predict(log_fit_abund, testing_data)
```

```{r}
abund_pred <- predict(log_fit_abund, testing_data, type = "prob") %>%
  bind_cols(testing_data %>% select(presence, ts))
abund_pred
```
```{r}
abund_pred %>%
  arrange(desc(.pred_1)) %>%
  print(n = 10)
```


```{r}
abund_pred %>%
  roc_curve(
    truth = presence,
    .pred_1,
    event_level = "second"
  ) %>%
  autoplot()


```
Not a good fit.